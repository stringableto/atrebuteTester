name: Auto Ad Viewer

on:
  # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ: Ø¯Ùˆ Ø¨Ø§Ø± Ø¯Ø± Ø±ÙˆØ²
  # Ø³Ø§Ø¹Øª 12 Ø¸Ù‡Ø± Ø§ÛŒØ±Ø§Ù† = 08:30 UTC
  # Ø³Ø§Ø¹Øª 12 Ø´Ø¨ Ø§ÛŒØ±Ø§Ù† = 20:30 UTC
  schedule:
  # Ø´Ù†Ø¨Ù‡
    - cron: "25 11 * * 6"
    - cron: "50 22 * * 6"

  # ÛŒÚ©Ø´Ù†Ø¨Ù‡
    - cron: "39 11 * * 0"
    - cron: "29 21 * * 0"

  # Ø¯ÙˆØ´Ù†Ø¨Ù‡
    - cron: "32 9 * * 1"
    - cron: "45 20 * * 1"

  # Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡
    - cron: "48 10 * * 2"
    - cron: "50 21 * * 2"

  # Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡
    - cron: "55 8 * * 3"
    - cron: "41 19 * * 3"

  # Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡
    - cron: "1 13 * * 4"
    - cron: "13 1 * * 5"   # Ø¨Ø§Ù…Ø¯Ø§Ø¯ Ø¬Ù…Ø¹Ù‡

  # Ø¬Ù…Ø¹Ù‡
    - cron: "9 18 * * 5"
    - cron: "50 2 * * 6"   # Ø¨Ø§Ù…Ø¯Ø§Ø¯ Ø´Ù†Ø¨Ù‡

    
  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  workflow_dispatch:

jobs:
  run-ad-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Ø¨Ø³ØªÙ† Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 20 Ø¯Ù‚ÛŒÙ‚Ù‡
    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create project files
        run: |
          # Ø§ÛŒØ¬Ø§Ø¯ package.json
          cat > package.json << 'EOF'
          {
            "name": "auto-ad-viewer",
            "version": "1.0.0",
            "description": "Automated ad viewer bot",
            "main": "index.js",
            "scripts": {
              "start": "node index.js"
            },
            "dependencies": {
              "playwright": "^1.40.0",
              "@google/generative-ai": "^0.21.0",
              "undici": "^6.0.0"
            }
          }
          EOF

          # Ø§ÛŒØ¬Ø§Ø¯ cookies.json Ø§Ø² secret
          echo '${{ secrets.COOKIES_JSON }}' > cookies.json

          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ index.js
          cat > index.js << 'EOFJS'
          const { chromium } = require('playwright');
          const fs = require('fs');
          const { GoogleGenerativeAI } = require("@google/generative-ai");
          const { setGlobalDispatcher, ProxyAgent } = require("undici");

          // Ø¯Ø±ÛŒØ§ÙØª Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
          const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
          const USE_PROXY = process.env.USE_PROXY === 'true';

          // ØªÙ†Ø¸ÛŒÙ… Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø§Ú¯Ø± ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
          if (USE_PROXY) {
              const proxyUrl = 'http://mtqggzas:25otjuhepz57@142.111.48.253:7030';
              const dispatcher = new ProxyAgent(proxyUrl);
              setGlobalDispatcher(dispatcher);
              console.log('Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù…ÛŒÙ†Ø§ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯.');
          }

          // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ù„ÛŒØ¯ API
          if (!GEMINI_API_KEY) {
              console.error('Ø®Ø·Ø§: Ú©Ù„ÛŒØ¯ API Ø¬Ù…ÛŒÙ†Ø§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
              process.exit(1);
          }

          const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

          async function run() {
              console.log('Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§: GitHub Actions');
              console.log('Ø­Ø§Ù„Øª Ù…Ø±ÙˆØ±Ú¯Ø±: Headless');
              
              const browser = await chromium.launch({ headless: true });
              const context = await browser.newContext();

              // Ø®ÙˆØ§Ù†Ø¯Ù† Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§
              try {
                  const cookiesString = fs.readFileSync('cookies.json', 'utf8');
                  const cookies = JSON.parse(cookiesString).map(cookie => {
                      if (cookie.sameSite === null) cookie.sameSite = "Lax";
                      return cookie;
                  });
                  await context.addCookies(cookies);
                  console.log('Ú©ÙˆÚ©ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.');
              } catch (error) {
                  console.error('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ cookies.json:', error);
                  await browser.close();
                  process.exit(1);
              }

              const page = await context.newPage();

              // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø§ÛŒØª
              console.log('Ø¯Ø± Ø­Ø§Ù„ Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ...');
              await page.goto('https://www.you-cubez.com/', { waitUntil: 'domcontentloaded' });

              // Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ ØªØ¨Ù„ÛŒØºØ§Øª
              console.log('Ø¯Ø± Ø­Ø§Ù„ Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ ØªØ¨Ù„ÛŒØºØ§Øª...');
              await page.goto('https://www.you-cubez.com/ptc_ads.php', { waitUntil: 'domcontentloaded' });

              // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØ¨Ù„ÛŒØºØ§Øª
              await processAds(page, context);
              
              console.log('Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
              await browser.close();
          }

          async function processAds(mainPage, context) {
              let adCount = 0;
              
              while (true) {
                  console.log(`\n--- Ø¨Ø±Ø±Ø³ÛŒ ØªØ¨Ù„ÛŒØº Ø´Ù…Ø§Ø±Ù‡ ${adCount + 1} ---`);
                  
                  const adLink = mainPage.locator('.thumb-info-content a').first();
                  const adExists = await adLink.count() > 0;
                  
                  if (!adExists) {
                      console.log('âœ“ ØªÙ…Ø§Ù… ØªØ¨Ù„ÛŒØºØ§Øª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù†Ø¯!');
                      break;
                  }
                  
                  console.log('ØªØ¨Ù„ÛŒØº Ù¾ÛŒØ¯Ø§ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ú©Ù„ÛŒÚ©...');
                  
                  const adPromise = context.waitForEvent('page');
                  await adLink.click();
                  const adPage = await adPromise;
                  await adPage.waitForLoadState('domcontentloaded');
                  console.log('ØªØ¨ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ø´Ø¯.');
                  
                  const success = await handleAdPage(adPage);
                  
                  if (success) {
                      console.log('âœ“ ØªØ¨Ù„ÛŒØº Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯.');
                      adCount++;
                  } else {
                      console.log('âœ— Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØ¨Ù„ÛŒØº.');
                  }
                  
                  console.log('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø³ØªÙ† ØªØ¨ ØªØ¨Ù„ÛŒØº...');
                  await adPage.close();
                  
                  console.log('Ø¯Ø± Ø­Ø§Ù„ Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ...');
                  await mainPage.reload({ waitUntil: 'domcontentloaded' });
                  await mainPage.waitForTimeout(2000);
              }
              
              console.log(`\nðŸŽ‰ Ú©Ù„ ØªØ¨Ù„ÛŒØºØ§Øª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡: ${adCount}`);
          }

          async function handleAdPage(adPage) {
              try {
                  const captchaExists = await adPage.locator('img[src*="captcha.php"]').count() > 0;
                  const botCheckExists = await adPage.locator('input[name="submit"][value*="REAL"]').count() > 0;
                  
                  if (captchaExists) {
                      console.log('â†’ Ú©Ù¾Ú†Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯.');
                      const captchaResolved = await handleCaptcha(adPage);
                      if (!captchaResolved) return false;
                  } else if (botCheckExists) {
                      console.log('â†’ Ø¯Ú©Ù…Ù‡ "I am REAL!" Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯.');
                      await adPage.click('input[name="submit"][value*="REAL"]');
                      await adPage.waitForLoadState('domcontentloaded');
                      console.log('âœ“ Ø¯Ú©Ù…Ù‡ "I am REAL!" Ú©Ù„ÛŒÚ© Ø´Ø¯.');
                  } else {
                      console.log('â†’ Ú©Ù¾Ú†Ø§ ÛŒØ§ bot check ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø§Ø¯Ø§Ù…Ù‡...');
                  }
                  
                  console.log('Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ "Click Me Now!"...');
                  
                  try {
                      await adPage.waitForSelector('input[name="submit_com"].button', { 
                          timeout: 45000,
                          state: 'visible'
                      });
                      
                      console.log('âœ“ Ø¯Ú©Ù…Ù‡ "Click Me Now!" Ø¸Ø§Ù‡Ø± Ø´Ø¯.');
                      await adPage.waitForTimeout(2500);
                      await adPage.click('input[name="submit_com"].button');
                      console.log('âœ“ Ø¯Ú©Ù…Ù‡ "Click Me Now!" Ú©Ù„ÛŒÚ© Ø´Ø¯.');
                      await adPage.waitForTimeout(5000);
                      
                      return true;
                  } catch (e) {
                      console.log('âœ— Ø¯Ú©Ù…Ù‡ "Click Me Now!" Ø¸Ø§Ù‡Ø± Ù†Ø´Ø¯ (Timeout).');
                      return false;
                  }
              } catch (error) {
                  console.error('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙØ­Ù‡ ØªØ¨Ù„ÛŒØº:', error.message);
                  return false;
              }
          }

          async function handleCaptcha(adPage) {
              try {
                  const captchaElement = adPage.locator('img[src*="captcha.php"]');
                  
                  console.log('Ø¯Ø± Ø­Ø§Ù„ Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ† Ø§Ø² Ú©Ù¾Ú†Ø§...');
                  const captchaPath = 'captcha.png';
                  await captchaElement.screenshot({ path: captchaPath });
                  
                  console.log('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¬Ù…ÛŒÙ†Ø§ÛŒ...');
                  const captchaText = await solveCaptchaWithGemini(captchaPath);
                  
                  if (!captchaText) {
                      console.log('âœ— Ø¬Ù…ÛŒÙ†Ø§ÛŒ Ù†ØªÙˆØ§Ù†Ø³Øª Ú©Ù¾Ú†Ø§ Ø±Ø§ Ø­Ù„ Ú©Ù†Ø¯.');
                      return false;
                  }
                  
                  console.log('Ù…ØªÙ† Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø§Ø² Ø¬Ù…ÛŒÙ†Ø§ÛŒ:', captchaText);
                  const cleanText = captchaText.replace(/[^a-zA-Z0-9]/g, '');
                  console.log('Ù…ØªÙ† ØªÙ…ÛŒØ² Ø´Ø¯Ù‡:', cleanText);
                  
                  await adPage.fill('input[name="Code"]', cleanText);
                  await adPage.click('input[name="submit"]');
                  await adPage.waitForLoadState('domcontentloaded');
                  
                  console.log('âœ“ Ú©Ù¾Ú†Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
                  return true;
              } catch (error) {
                  console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ù„ Ú©Ù¾Ú†Ø§:', error.message);
                  return false;
              }
          }

          async function solveCaptchaWithGemini(imagePath) {
              try {
                  const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                  
                  const imageBuffer = fs.readFileSync(imagePath);
                  const imageBase64 = imageBuffer.toString('base64');

                  const prompt = "Strictly output ONLY the alphanumeric text found in this CAPTCHA image. No introductions, no explanations, no markdown, no spaces. Just the raw characters.";

                  const result = await model.generateContent([
                      prompt,
                      {
                          inlineData: {
                              data: imageBase64,
                              mimeType: "image/png",
                          },
                      },
                  ]);

                  const response = await result.response;
                  return response.text().trim();
              } catch (error) {
                  console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¬Ù…ÛŒÙ†Ø§ÛŒ:', error);
                  return null;
              }
          }

          run().catch(err => {
              console.error('Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ:', err);
              process.exit(1);
          });
          EOFJS

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run ad automation
        run: node index.js
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USE_PROXY: ${{ secrets.USE_PROXY }}

      - name: Upload screenshot artifacts (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ github.run_number }}
          path: '*.png'
          if-no-files-found: ignore
